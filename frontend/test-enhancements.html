<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试前端增强功能</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="static/css/style.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <h2>前端增强功能测试</h2>
        <div class="alert alert-info">
            <h5>测试功能：</h5>
            <ul>
                <li><strong>图片懒加载：</strong> 滚动页面时图片才会加载</li>
                <li><strong>图片点击放大：</strong> 点击图片卡片查看大图预览</li>
                <li><strong>键盘导航：</strong> 在预览模式下使用左右箭头键切换图片，ESC键关闭</li>
            </ul>
        </div>
        
        <div id="testGallery" class="row">
            <!-- Test cards will be inserted here -->
        </div>
    </div>

    <!-- Bootstrap 5 JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Mock API Client for testing
        class MockAPIClient {
            getImageUrl(filename) {
                return `https://via.placeholder.com/400x300?text=${filename}`;
            }
            getDownloadUrl(filename) {
                return '#';
            }
        }
        
        // Test data
        const testFiles = [
            { png_file: { name: '图片1.png', size: 102400 }, csv_file: { name: '图片1.csv' }, has_csv: true },
            { png_file: { name: '图片2.png', size: 204800 }, csv_file: { name: '图片2.csv' }, has_csv: true },
            { png_file: { name: '图片3.png', size: 153600 }, csv_file: null, has_csv: false },
            { png_file: { name: '图片4.png', size: 307200 }, csv_file: { name: '图片4.csv' }, has_csv: true },
            { png_file: { name: '图片5.png', size: 256000 }, csv_file: null, has_csv: false },
            { png_file: { name: '图片6.png', size: 409600 }, csv_file: { name: '图片6.csv' }, has_csv: true }
        ];
        
        // Initialize test
        document.addEventListener('DOMContentLoaded', () => {
            const mockClient = new MockAPIClient();
            
            // Create a simplified UI controller for testing
            const testGallery = document.getElementById('testGallery');
            const imageElements = [];
            let currentImageIndex = -1;
            let lazyLoadObserver = null;
            
            // Initialize lazy loading
            if ('IntersectionObserver' in window) {
                lazyLoadObserver = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const img = entry.target;
                            const src = img.getAttribute('data-src');
                            if (src) {
                                img.src = src;
                                img.removeAttribute('data-src');
                                lazyLoadObserver.unobserve(img);
                            }
                        }
                    });
                }, { rootMargin: '50px' });
            }
            
            // Create modal
            const modalHTML = `
                <div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-xl modal-dialog-centered">
                        <div class="modal-content bg-dark">
                            <div class="modal-header border-0">
                                <h5 class="modal-title text-white" id="imagePreviewTitle"></h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="关闭"></button>
                            </div>
                            <div class="modal-body text-center p-0">
                                <img id="previewImage" class="img-fluid" alt="预览图片" style="max-height: 80vh;">
                            </div>
                            <div class="modal-footer border-0 justify-content-between">
                                <button type="button" class="btn btn-outline-light" id="prevImageBtn">
                                    <i class="bi bi-chevron-left"></i> 上一张
                                </button>
                                <span class="text-white" id="imageCounter"></span>
                                <button type="button" class="btn btn-outline-light" id="nextImageBtn">
                                    下一张 <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            const previewModal = new bootstrap.Modal(document.getElementById('imagePreviewModal'));
            const previewImage = document.getElementById('previewImage');
            const previewTitle = document.getElementById('imagePreviewTitle');
            const imageCounter = document.getElementById('imageCounter');
            const prevImageBtn = document.getElementById('prevImageBtn');
            const nextImageBtn = document.getElementById('nextImageBtn');
            
            // Render test cards
            testFiles.forEach((fileData, index) => {
                const col = document.createElement('div');
                col.className = 'col-md-4 col-lg-3 mb-4';
                
                const imageUrl = mockClient.getImageUrl(fileData.png_file.name);
                
                col.innerHTML = `
                    <div class="card h-100 shadow-sm">
                        <div class="position-relative image-card-container" style="cursor: pointer;">
                            <img ${lazyLoadObserver ? `data-src="${imageUrl}"` : `src="${imageUrl}"`}
                                 class="card-img-top lazy-image" 
                                 alt="${fileData.png_file.name}">
                            ${fileData.has_csv ? 
                                '<span class="badge bg-success status-badge"><i class="bi bi-check-circle"></i></span>' :
                                '<span class="badge bg-warning status-badge"><i class="bi bi-exclamation-circle"></i></span>'
                            }
                            <div class="image-overlay">
                                <i class="bi bi-zoom-in"></i>
                            </div>
                        </div>
                        <div class="card-body">
                            <h6 class="card-title">${fileData.png_file.name}</h6>
                            <div class="file-info">
                                <small class="text-muted">
                                    <i class="bi bi-file-earmark-image"></i>
                                    ${(fileData.png_file.size / 1024).toFixed(1)} KB
                                </small>
                            </div>
                        </div>
                    </div>
                `;
                
                testGallery.appendChild(col);
                
                const imgElement = col.querySelector('.lazy-image');
                if (lazyLoadObserver && imgElement) {
                    lazyLoadObserver.observe(imgElement);
                }
                
                imageElements.push({ url: imageUrl, filename: fileData.png_file.name });
                
                const imageContainer = col.querySelector('.image-card-container');
                imageContainer.addEventListener('click', () => {
                    currentImageIndex = index;
                    previewImage.src = imageElements[index].url;
                    previewTitle.textContent = imageElements[index].filename;
                    imageCounter.textContent = `${index + 1} / ${imageElements.length}`;
                    prevImageBtn.disabled = index === 0;
                    nextImageBtn.disabled = index === imageElements.length - 1;
                    previewModal.show();
                });
            });
            
            // Navigation handlers
            prevImageBtn.addEventListener('click', () => {
                if (currentImageIndex > 0) {
                    currentImageIndex--;
                    previewImage.src = imageElements[currentImageIndex].url;
                    previewTitle.textContent = imageElements[currentImageIndex].filename;
                    imageCounter.textContent = `${currentImageIndex + 1} / ${imageElements.length}`;
                    prevImageBtn.disabled = currentImageIndex === 0;
                    nextImageBtn.disabled = false;
                }
            });
            
            nextImageBtn.addEventListener('click', () => {
                if (currentImageIndex < imageElements.length - 1) {
                    currentImageIndex++;
                    previewImage.src = imageElements[currentImageIndex].url;
                    previewTitle.textContent = imageElements[currentImageIndex].filename;
                    imageCounter.textContent = `${currentImageIndex + 1} / ${imageElements.length}`;
                    prevImageBtn.disabled = false;
                    nextImageBtn.disabled = currentImageIndex === imageElements.length - 1;
                }
            });
            
            // Keyboard navigation
            document.addEventListener('keydown', (e) => {
                const modalElement = document.getElementById('imagePreviewModal');
                if (modalElement.classList.contains('show')) {
                    if (e.key === 'ArrowLeft' && currentImageIndex > 0) {
                        prevImageBtn.click();
                    } else if (e.key === 'ArrowRight' && currentImageIndex < imageElements.length - 1) {
                        nextImageBtn.click();
                    } else if (e.key === 'Escape') {
                        previewModal.hide();
                    }
                }
            });
            
            console.log('测试页面加载完成');
            console.log('- 懒加载已启用:', lazyLoadObserver !== null);
            console.log('- 图片数量:', imageElements.length);
        });
    </script>
</body>
</html>
